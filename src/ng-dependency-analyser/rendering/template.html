<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>Angular Dependency Analysis</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
        <script src="http://cpettitt.github.io/project/dagre-d3/latest/dagre-d3.js"></script>
        <style>
            body {
                font-weight: 300;
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            }

            svg {
                overflow: hidden;
                margin: 0 auto;
            }

            text {
                font-size: 14px;
            }

            .node rect, .node ellipse {
                stroke: #999;
                fill: #fff;
                stroke-width: 1.5px;
            }

            .node[id] {
                cursor: pointer;
            }

            .edgePath path {
                stroke: #333;
                stroke-width: 1.5px;
            }
        </style>
    </head>
    <body>
        <svg id="ngda" width="4096" height="2048"></svg>
        <script>
            var g = new dagreD3.graphlib.Graph()
                    .setGraph({})
                    .setDefaultEdgeLabel(function () {
                        return {};
                    });

            // MODULES
            {{~it.getModules() :module}}
              // Module as import name and name as label
              g.setNode('{{= module.importName}}', {id: '{{= module.importName}}', label: '{{= module.name}}', shape: 'rect'});
              {{~module.requires :required}}

              // Required as import name
              g.setNode('{{= required}}', {id: '{{= required}}', shape: 'rect'});
              {{~}}
              {{~module.provides :provide}}

              // Provided as import name and name as label
              g.setNode('{{= provide.importName}}', {id: '{{= provide.importName}}', label: '{{= provide.name}}', shape: 'ellipse'});
              {{~}}
            {{~}}

            {{~it.getModules() :module}}
              {{~module.requires :required}}
              g.setEdge('{{= module.importName}}', '{{= required }}', {label: 'requires'});
              {{~}}
            {{~}}

            {{~it.getModules() :module}}
              {{~module.provides :provide}}
              g.setEdge('{{= module.importName}}', '{{= provide.importName }}', {label: 'provides'});
              {{~}}
            {{~}}

            // DEPENDENCIES
            {{~it.getInjectedDependencies() :injectedDependency}}
              // File as import name where dependencies are injected
              g.setNode('{{= injectedDependency.importName}}', {id: '{{= injectedDependency.importName}}', label: previousLabel(g, '{{= injectedDependency.importName}}'), shape: 'ellipse'});
              {{~injectedDependency.dependencies :dependency}}
              // Injected dependency as import name with name as label
              g.setNode('{{= dependency.importName}}', {id: '{{= dependency.importName}}', label: '{{= dependency.name}}', shape: 'ellipse'});
              {{~}}
            {{~}}

            {{~it.getInjectedDependencies() :injectedDependency}}
            {{~injectedDependency.dependencies :dependency}}
              g.setEdge('{{= injectedDependency.importName}}', '{{= dependency.importName }}', {label: 'uses'});
            {{~}}
            {{~}}

            var render = new dagreD3.render(), svg = d3.select('#ngda'), svgGroup = svg.append('g');

            render(d3.select('#ngda g'), g);

            var xCenterOffset = (svg.attr('width') - g.graph().width) / 2;

            svgGroup.attr('transform', 'translate(' + xCenterOffset + ', 20)');
            svg.attr('height', g.graph().height + 40);

            svg.select('g').selectAll('g.node').on('click', function(id) {
                var fileName = getFileNameForImportName(id);

                if (fileName) {
                    var url = '{{= it.getUrlTemplate() || "" }}'.replace('${fileName}', fileName);

                    window.open(url);
                }
            });

            function previousLabel(g, nodeId) {
                var node = g.node(nodeId);

                return node && node.label;
            }

            function getFileNameForImportName(importName) {
                var importNamesToFileNames = {{= JSON.stringify(it.getImportNamesToFileNames()) }};

                return importNamesToFileNames[importName];
            }
        </script>
    </body>
</html>
