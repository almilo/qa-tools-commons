<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>Angular Dependency Analysis</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
        <script src="http://cpettitt.github.io/project/dagre-d3/latest/dagre-d3.js"></script>
        <script src="http://cpettitt.github.io/project/graphlib-dot/latest/graphlib-dot.js"></script>
        <style>
            body {
                width: 6000px;
                height: 4000px;
                font-weight: 300;
                font-family: Arial, sans-serif;
            }

            svg {
                overflow: hidden;
                margin: 0 auto;
            }

            text {
                font-size: 14px;
            }

            h1 {
                margin-top: 1em;
                margin-bottom: 1em;
            }

            .node rect, .node ellipse, .node polygon {
                stroke: #999;
                fill: #fff;
                stroke-width: 1px;
            }

            .node[id] {
                cursor: pointer;
            }

            .edgePath path {
                stroke: #333;
                stroke-width: 1px;
            }
        </style>
    </head>
    <body>
        <h1 class="text-center">Angular Dependencies Graph</h1>

        <svg id="ngda" width="6000" height="4000"></svg>

        <script id="dot" language="text/dot">
            {{= it.dot}}
        </script>

        <script>
            var data = {{= JSON.stringify(it.report.getData())}},
                dot = document.getElementById('dot').innerHTML, g = graphlibDot.read(dot),
                svg = renderGraph('#ngda', g);

            svg.select('g').selectAll('g.node').on('click', openFile);
            svg.select('g').selectAll('g.node rect, g.node ellipse, g.node polygon').style('fill', getFillColor);

            function renderGraph(svgSelector, g) {
                var render = new dagreD3.render(), svg = d3.select(svgSelector), svgGroup = svg.append('g');

                render(d3.select(svgSelector + ' g'), g);

                var xCenterOffset = (svg.attr('width') - g.graph().width) / 2;

                svgGroup.attr('transform', 'translate(' + xCenterOffset + ', 20)');
                svg.attr('height', g.graph().height + 40);

                return svg;
            }

            function openFile(id) {
                var fileName = data[id].fileName;

                if (fileName) {
                    window.open(replaceFileNamePlaceholder(id));
                }

                function replaceFileNamePlaceholder(id) {
                    return '{{= it.report.getUrlTemplate() || "" }}'.replace('${fileName}', id);
                }
            }

            function getFillColor(id) {
                var layerColors = {
                            'app': 'white',
                            'lib/ui': 'ivory',
                            'lib/core': 'aliceblue'
                        },
                        typeColors = {
                            'directive': 'mistyrose'
                        },
                        itemData = (data[id] || {});

                return typeColors[itemData.type] || layerColors[itemData.layer];
            }
        </script>
    </body>
</html>
