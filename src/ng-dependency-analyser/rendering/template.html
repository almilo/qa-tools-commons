<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>Angular Dependency Analysis</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
        <script src="http://cpettitt.github.io/project/dagre-d3/latest/dagre-d3.js"></script>
        <script src="http://cpettitt.github.io/project/graphlib-dot/latest/graphlib-dot.js"></script>
        <style>
            body {
                font-weight: 300;
                font-family: Arial, sans-serif;
            }

            svg {
                overflow: hidden;
                margin: 0 auto;
            }

            text {
                font-size: 14px;
            }

            h1 {
                margin-top: 1em;
                margin-bottom: 1em;
            }

            #ngda-container {
                width: 100%;
                overflow: scroll;
            }

            .node rect, .node ellipse, .node polygon {
                stroke: #999;
                fill: #fff;
                stroke-width: 1px;
            }

            .node[id] {
                cursor: pointer;
            }

            .edgePath path {
                stroke: #333;
                stroke-width: 1px;
            }
        </style>
    </head>
    <body>
        <h1 class="text-center">Angular Dependencies Graph</h1>

        <div id="ngda-container">
            <svg id="ngda" width="6000" height="4000"></svg>
        </div>

        <script id="dot" language="text/dot">
            {{= it.dot}}
        </script>

        <script>
            var dot = document.getElementById('dot').innerHTML, g = graphlibDot.read(dot),
                    svg = renderGraph('#ngda', g), ngdaContainer = document.getElementById('ngda-container');

            ngdaContainer.scrollLeft = (ngdaContainer.scrollWidth - ngdaContainer.clientWidth) / 2;

            svg.select('g').selectAll('g.node').on('click', openFile);

            function renderGraph(svgSelector, g) {
                var render = new dagreD3.render(), svg = d3.select(svgSelector), svgGroup = svg.append('g');

                render(d3.select(svgSelector + ' g'), g);

                var xCenterOffset = (svg.attr('width') - g.graph().width) / 2;

                svgGroup.attr('transform', 'translate(' + xCenterOffset + ', 20)');
                svg.attr('height', g.graph().height + 40);

                return svg;
            }

            function openFile(id) {
                var fileName = getFileNameForImportName(id);

                if (fileName) {
                    window.open(replaceFileNamePlaceholder(id));
                }

                function replaceFileNamePlaceholder(id) {
                    return '{{= it.report.getUrlTemplate() || "" }}'.replace('${fileName}', id);
                }
            }

            function getFileNameForImportName(importName) {
                var importNamesToFileNames = {{= JSON.stringify(it.report.getImportNamesToFileNames())}};

                return importNamesToFileNames[importName];
            }
        </script>
    </body>
</html>
